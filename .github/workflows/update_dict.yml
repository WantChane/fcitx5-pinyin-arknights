name: update and release
on:  
  schedule:  
    - cron: '0 20 14 * *'  
  workflow_dispatch:

permissions:
  contents: write

jobs:  
  build:  
    runs-on: ubuntu-latest  
    steps:  
      - name: checkout@v4
        uses: actions/checkout@v4  
  
      - name: setup-python@v5  
        uses: actions/setup-python@v5  
        with:  
          python-version: '3.10'  
            
      - name: install libime  
        run: sudo apt install -y libime-bin  
          
      - name: install requirements  
        run: |  
          pip install -r requirements.txt  
            
      - name: run mw2fcitx  
        run: mw2fcitx -c prts.py  

      - name: Generate checksums
        id: checksums
        run: |
          DICT_SHA=$(sha256sum prts.dict | awk '{ print $1 }')
          YAML_SHA=$(sha256sum prts.dict.yaml | awk '{ print $1 }')
          echo "dict_sha=$DICT_SHA" >> $GITHUB_OUTPUT
          echo "yaml_sha=$YAML_SHA" >> $GITHUB_OUTPUT

      - name: get date str 
        id: date  
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT  
          
      - name: create Release  
        id: create_release  
        uses: softprops/action-gh-release@v2  
        with:  
          tag_name: v${{ steps.date.outputs.date }}  
          name: Release ${{ steps.date.outputs.date }}  
          body: |
            ### Checksums
            - prts.dict: `${{ steps.checksums.outputs.dict_sha }}`
            - prts.dict.yaml: `${{ steps.checksums.outputs.yaml_sha }}`

            > 本版本由GitHub Actions定时任务生成
          files: |  
            prts.dict
            prts.dict.yaml  
          draft: false  
          prerelease: false  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}