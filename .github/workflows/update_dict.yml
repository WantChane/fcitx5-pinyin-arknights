name: update and release
on:  
  schedule:  
    - cron: '0 20 14 * *'  
  workflow_dispatch:

permissions:
  contents: write

jobs:  
  build:  
    runs-on: ubuntu-latest  
    steps:  
      - name: checkout@v4
        uses: actions/checkout@v4  
  
      - name: setup-python@v5  
        uses: actions/setup-python@v5  
        with:  
          python-version: '3.10'  
            
      - name: install libime  
        run: sudo apt install -y libime-bin  

      - name: install p7zip  
        run: sudo apt install -y p7zip 
          
      - name: install requirements  
        run: pip install -r requirements.txt  
            
      - name: run script/build.sh
        run: |
          chmod +x script/build.sh
          ./script/build.sh

      - name: Package .dict.yaml files into 7z
        run: |
          cd output
          rm -f cn_dicts.7z
          find . -name "*.dict.yaml" -print0 | xargs -0 7z a cn_dicts.7z

      - name: Generate checksums file
        run: |
          cd output
          rm -f checksums.txt
          find . -type f -name "prts_*" -exec sha256sum {} + | sed 's|\./||' > checksums.txt

      - name: get date str 
        id: date  
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT  
          
      - name: create Release  
        id: create_release  
        uses: softprops/action-gh-release@v2  
        with:  
          tag_name: v${{ steps.date.outputs.date }}  
          name: Release ${{ steps.date.outputs.date }}  
          body: |
            该Release由GitHub Actions定时任务生成
          files: |
            output/*
          draft: false  
          prerelease: false  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}